<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com https://api.spotify.com https://accounts.spotify.com; frame-src 'self' https://www.youtube.com https://trytako.com https://accounts.spotify.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify to Apple Music Track Mapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        spotify: '#1DB954',
                        apple: '#FA243C'
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #5D5CDE 0%, #8B5CF6 100%);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            transition: transform 0.2s ease-in-out;
        }
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-200">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="gradient-bg py-8">
            <div class="container mx-auto px-4">
                <h1 class="text-4xl font-bold text-white text-center mb-2">
                    üéµ Track Mapper
                </h1>
                <p class="text-white/90 text-center text-lg">
                    Map your Spotify tracks to Apple Music with precision
                </p>
                <div class="text-center mt-4">
                    <span id="auth-status" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-white/20 text-white">
                        üîê Click "Connect Spotify" to get started
                    </span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="container mx-auto px-4 py-8 max-w-4xl">
            <!-- Redirect URI Helper -->
            <div id="redirect-uri-helper" class="bg-amber-50 dark:bg-amber-900/20 rounded-2xl p-6 mb-8">
                <h3 class="text-lg font-semibold mb-3 text-amber-900 dark:text-amber-100">
                    üîß Spotify Setup Instructions
                </h3>
                <div class="text-amber-800 dark:text-amber-200 space-y-3 text-sm">
                    <p><strong>Add this URL to your Spotify app settings:</strong></p>
                    <div class="bg-amber-100 dark:bg-amber-800 p-3 rounded-lg">
                        <code id="current-url" class="text-sm font-mono break-all"></code>
                        <button id="copy-url" class="ml-2 text-amber-600 hover:text-amber-800 dark:text-amber-300 dark:hover:text-amber-100">
                            üìã Copy
                        </button>
                    </div>
                    <div class="text-xs">
                        <strong>Quick Steps:</strong>
                        <ol class="list-decimal list-inside ml-2 space-y-1">
                            <li>Go to <a href="https://developer.spotify.com/dashboard" class="underline font-medium" target="_blank">Spotify Developer Dashboard</a></li>
                            <li>Click on your app ‚Üí "Edit Settings"</li>
                            <li>Paste the URL above in "Redirect URIs"</li>
                            <li>Click "Add" then "Save"</li>
                            <li>Try connecting below</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- Spotify Authentication -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-semibold mb-4 flex items-center">
                    <span class="w-8 h-8 bg-spotify rounded-full flex items-center justify-center text-white text-sm mr-3">üîê</span>
                    Spotify Connection
                </h2>
                
                <div id="auth-section">
                    <div id="login-section">
                        <p class="text-gray-600 dark:text-gray-400 mb-4">Connect your Spotify account to access your playlists:</p>
                        <button id="connect-spotify-btn" class="bg-spotify hover:bg-green-600 text-white font-medium py-3 px-6 rounded-lg transition-colors">
                            üéµ Connect to Spotify
                        </button>
                        <p class="text-xs text-green-600 dark:text-green-400 mt-2">
                            ‚úÖ Using modern OAuth 2.0 PKCE authentication
                        </p>
                    </div>
                    
                    <div id="authenticated-section" class="hidden">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-600 dark:text-green-400 font-medium">‚úÖ Connected to Spotify</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400" id="user-info">You can now access your playlists</p>
                            </div>
                            <button id="disconnect-btn" class="text-red-600 hover:text-red-700 font-medium">
                                Disconnect
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Section -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 mb-8">
                <h2 class="text-2xl font-semibold mb-4 flex items-center">
                    <span class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white text-sm mr-3">1</span>
                    Input Track Information
                </h2>
                
                <div class="space-y-4">
                    <!-- Tab Selection -->
                    <div class="flex space-x-1 bg-gray-100 dark:bg-gray-700 rounded-lg p-1">
                        <button id="tab-single" class="tab-btn flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors active bg-white dark:bg-gray-800 text-primary">
                            Single Track
                        </button>
                        <button id="tab-playlist" class="tab-btn flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors">
                            Spotify Playlist
                        </button>
                        <button id="tab-library" class="tab-btn flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors">
                            My Library
                        </button>
                        <button id="tab-batch" class="tab-btn flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors">
                            Batch Input
                        </button>
                    </div>

                    <!-- Single Track Tab -->
                    <div id="single-track-content" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Track Name *</label>
                                <input type="text" id="track-name" placeholder="e.g., Blinding Lights" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Artist Name *</label>
                                <input type="text" id="artist-name" placeholder="e.g., The Weeknd" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Album Name</label>
                                <input type="text" id="album-name" placeholder="e.g., After Hours" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Duration (optional)</label>
                                <input type="text" id="duration" placeholder="e.g., 3:20 or 200000ms" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base">
                            </div>
                        </div>
                    </div>

                    <!-- Playlist Tab -->
                    <div id="playlist-content" class="tab-content hidden">
                        <div>
                            <label class="block text-sm font-medium mb-2">Spotify Playlist URL</label>
                            <input type="url" id="playlist-url" placeholder="https://open.spotify.com/playlist/..." class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base">
                            <p class="text-sm text-green-600 dark:text-green-400 mt-2 flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                ‚úÖ Real Spotify API - Fetches actual playlists
                            </p>
                        </div>
                    </div>

                    <!-- My Library Tab -->
                    <div id="library-content" class="tab-content hidden">
                        <div class="space-y-4">
                            <p class="text-gray-600 dark:text-gray-400">Connect to Spotify to see your saved tracks and playlists</p>
                            <div id="library-section" class="hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Saved Tracks</label>
                                        <button id="load-saved-tracks" class="w-full px-4 py-3 bg-spotify hover:bg-green-600 text-white rounded-lg transition-colors">
                                            üì± Load My Liked Songs
                                        </button>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">My Playlists</label>
                                        <select id="user-playlists" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary dark:bg-gray-700">
                                            <option value="">Select a playlist...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Batch Tab -->
                    <div id="batch-content" class="tab-content hidden">
                        <div>
                            <label class="block text-sm font-medium mb-2">Track List</label>
                            <textarea id="batch-tracks" rows="8" placeholder="Enter tracks, one per line:
Track Name - Artist Name
Blinding Lights - The Weeknd
Shape of You - Ed Sheeran
Someone Like You - Adele
Bohemian Rhapsody - Queen
..." class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 text-base resize-vertical"></textarea>
                        </div>
                    </div>

                    <!-- Search Button -->
                    <button id="search-btn" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="search-text">üîç Find Apple Music Matches</span>
                        <span id="search-loading" class="hidden">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="loading-dots">Searching</span>
                        </span>
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-semibold mb-4 flex items-center">
                        <span class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white text-sm mr-3">2</span>
                        Mapping Results
                    </h2>
                    
                    <!-- Results Summary -->
                    <div id="results-summary" class="mb-6"></div>
                    
                    <!-- Results List -->
                    <div id="results-list" class="space-y-4"></div>
                    
                    <!-- Export Options -->
                    <div id="export-section" class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg font-medium mb-3">Export Results</h3>
                        <div class="flex flex-wrap gap-3">
                            <button id="export-json" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">üìÑ Export JSON</button>
                            <button id="export-csv" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">üìä Export CSV</button>
                            <button id="export-txt" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">üìù Export TXT</button>
                            <button id="copy-results" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors">üìã Copy to Clipboard</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Examples -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-2xl p-6 mt-8">
                <h3 class="text-lg font-semibold mb-3 text-blue-900 dark:text-blue-100">
                    üöÄ Quick Start Examples
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <h4 class="font-medium text-blue-800 dark:text-blue-200 mb-2">Single Track</h4>
                        <button class="example-btn w-full text-left p-3 bg-white dark:bg-gray-800 rounded-lg border border-blue-200 dark:border-blue-700 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors" data-type="single" data-track="Blinding Lights" data-artist="The Weeknd" data-album="After Hours">
                            <div class="font-medium">Blinding Lights</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">The Weeknd ‚Ä¢ After Hours</div>
                        </button>
                    </div>
                    <div>
                        <h4 class="font-medium text-blue-800 dark:text-blue-200 mb-2">Real Playlist</h4>
                        <button class="example-btn w-full text-left p-3 bg-white dark:bg-gray-800 rounded-lg border border-blue-200 dark:border-blue-700 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors" data-type="playlist">
                            <div class="font-medium">Any Spotify Playlist</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Paste URL after connecting</div>
                        </button>
                    </div>
                    <div>
                        <h4 class="font-medium text-blue-800 dark:text-blue-200 mb-2">Your Music</h4>
                        <button class="example-btn w-full text-left p-3 bg-white dark:bg-gray-800 rounded-lg border border-blue-200 dark:border-blue-700 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors" data-type="library">
                            <div class="font-medium">Liked Songs</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Your personal library</div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-2xl p-6 mt-8">
                <h3 class="text-lg font-semibold mb-3 text-blue-900 dark:text-blue-100">
                    üìñ How It Works
                </h3>
                <div class="text-blue-800 dark:text-blue-200 space-y-2">
                    <p><strong>1. Connect Spotify:</strong> Authenticate with your Spotify account to access playlists and library.</p>
                    <p><strong>2. Real Data:</strong> Fetches actual track metadata from Spotify including ISRC, duration, and popularity.</p>
                    <p><strong>3. Smart Matching:</strong> Uses advanced algorithms to find Apple Music equivalents based on multiple criteria.</p>
                    <p><strong>4. Export Results:</strong> Download comprehensive mapping results in multiple formats.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let mappingResults = [];
        let spotifyToken = null;
        let currentUser = null;
        
        // Your Spotify Client ID
        const SPOTIFY_CLIENT_ID = 'ed6e006e361743a38c5b94660298ce7a';
        
        // Spotify API configuration
        const SPOTIFY_AUTH_URL = 'https://accounts.spotify.com/authorize';
        const SPOTIFY_API_URL = 'https://api.spotify.com/v1';
        const REDIRECT_URI = window.location.href.split('#')[0].split('?')[0];

        // Check for Spotify token on load
        window.addEventListener('load', () => {
            checkForSpotifyToken();
            setupRedirectURIHelper();
        });

        // Setup redirect URI helper
        function setupRedirectURIHelper() {
            const currentUrlElement = document.getElementById('current-url');
            const copyUrlButton = document.getElementById('copy-url');
            
            if (currentUrlElement) {
                currentUrlElement.textContent = REDIRECT_URI;
            }
            
            if (copyUrlButton) {
                copyUrlButton.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(REDIRECT_URI);
                        showSuccess("Redirect URI copied to clipboard!");
                    } catch (err) {
                        const textArea = document.createElement('textarea');
                        textArea.value = REDIRECT_URI;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showSuccess("Redirect URI copied to clipboard!");
                    }
                });
            }
        }

        // Check for Spotify token in URL
        function checkForSpotifyToken() {
            // Check URL parameters (authorization code flow)
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const state = urlParams.get('state');
            
            if (error) {
                showError(`Spotify authentication error: ${error}`);
                return;
            }
            
            if (code) {
                // Verify state parameter
                const savedState = localStorage.getItem('spotify_auth_state');
                if (state !== savedState) {
                    showError("Invalid state parameter. Please try connecting again.");
                    return;
                }
                
                // Exchange code for token
                exchangeCodeForToken(code);
                return;
            }
            
            // Check URL fragment (implicit flow fallback)
            const hash = window.location.hash.substring(1);
            const hashParams = new URLSearchParams(hash);
            const token = hashParams.get('access_token');
            const hashError = hashParams.get('error');
            
            if (hashError) {
                showError(`Spotify authentication error: ${hashError}`);
                return;
            }
            
            if (token) {
                spotifyToken = token;
                // Clear the hash from URL
                window.location.hash = '';
                updateAuthStatus(true);
                loadUserProfile();
                showSuccess("Successfully connected to Spotify using alternative method!");
                return;
            }
            
            // Check for saved token
            const savedToken = localStorage.getItem('spotify_token');
            const tokenExpiry = localStorage.getItem('spotify_token_expiry');
            
            if (savedToken && tokenExpiry && Date.now() < parseInt(tokenExpiry)) {
                spotifyToken = savedToken;
                updateAuthStatus(true);
                loadUserProfile();
            }
        }

        async function exchangeCodeForToken(code) {
            try {
                const codeVerifier = localStorage.getItem('spotify_code_verifier');
                if (!codeVerifier) {
                    throw new Error('Code verifier not found. Please try connecting again.');
                }
                
                // Try PKCE first, fall back to implicit flow if CORS fails
                try {
                    const response = await fetch('https://accounts.spotify.com/api/token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            client_id: SPOTIFY_CLIENT_ID,
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: REDIRECT_URI,
                            code_verifier: codeVerifier,
                        }),
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Token exchange failed: ${errorData.error_description || errorData.error}`);
                    }
                    
                    const tokenData = await response.json();
                    spotifyToken = tokenData.access_token;
                    
                    // Clean up stored values
                    localStorage.removeItem('spotify_code_verifier');
                    localStorage.removeItem('spotify_auth_state');
                    
                    // Clear URL parameters
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    updateAuthStatus(true);
                    loadUserProfile();
                    showSuccess("Successfully connected to Spotify!");
                    
                } catch (fetchError) {
                    // If CORS error, fall back to implicit flow
                    if (fetchError.message.includes('CORS') || fetchError.message.includes('Load failed') || fetchError.message.includes('Failed to fetch')) {
                        showError("CORS restriction detected. Switching to alternative authentication method...");
                        
                        // Clean up PKCE data
                        localStorage.removeItem('spotify_code_verifier');
                        localStorage.removeItem('spotify_auth_state');
                        
                        // Use implicit flow as fallback
                        setTimeout(() => {
                            useImplicitFlow();
                        }, 2000);
                        return;
                    }
                    throw fetchError;
                }
                
            } catch (error) {
                console.error('Token exchange error:', error);
                showError(`Authentication failed: ${error.message}. Please try the alternative method below.`);
                
                // Clean up
                localStorage.removeItem('spotify_code_verifier');
                localStorage.removeItem('spotify_auth_state');
                
                // Show fallback option
                showImplicitFlowFallback();
            }
        }

        function useImplicitFlow() {
            // Since both PKCE and implicit flows have issues, we'll use a CORS proxy approach
            showInstructionsForCORSFix();
        }

        function showInstructionsForCORSFix() {
            const instructionsDiv = document.createElement('div');
            instructionsDiv.id = 'cors-instructions';
            instructionsDiv.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-2xl mx-4 max-h-96 overflow-y-auto">
                        <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">
                            üîß Spotify Authentication Solutions
                        </h3>
                        <div class="space-y-4 text-sm">
                            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-900 dark:text-blue-100 mb-2">Option 1: Try without authentication (Limited features)</h4>
                                <p class="text-blue-800 dark:text-blue-200 mb-3">Use the app without Spotify login. You can still test single tracks and batch processing.</p>
                                <button id="skip-auth" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                    Continue Without Spotify
                                </button>
                            </div>
                            
                            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-900 dark:text-green-100 mb-2">Option 2: Run a local server (Recommended)</h4>
                                <p class="text-green-800 dark:text-green-200 mb-2">This bypasses CORS restrictions and enables full Spotify integration:</p>
                                <ol class="list-decimal list-inside text-green-700 dark:text-green-300 space-y-1 mb-3">
                                    <li>Install Python (if not installed): <a href="https://python.org" class="underline" target="_blank">python.org</a></li>
                                    <li>Save this HTML file in a folder (e.g., <code>track-mapper.html</code>)</li>
                                    <li>Open Terminal/Command Prompt in that folder</li>
                                    <li>Run: <code class="bg-green-100 dark:bg-green-800 px-1 rounded">python -m http.server 8000</code></li>
                                    <li>Open: <code class="bg-green-100 dark:bg-green-800 px-1 rounded">http://localhost:8000/track-mapper.html</code></li>
                                    <li>Update your Spotify app redirect URI to: <code class="bg-green-100 dark:bg-green-800 px-1 rounded">http://localhost:8000/track-mapper.html</code></li>
                                </ol>
                                <button id="copy-python-command" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg mr-2">
                                    üìã Copy Python Command
                                </button>
                                <button id="copy-localhost-url" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                                    üìã Copy Localhost URL
                                </button>
                            </div>
                            
                            <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                                <h4 class="font-semibold text-purple-900 dark:text-purple-100 mb-2">Option 3: Use a hosting service</h4>
                                <p class="text-purple-800 dark:text-purple-200 mb-2">Upload the HTML file to a free hosting service:</p>
                                <ul class="list-disc list-inside text-purple-700 dark:text-purple-300 space-y-1">
                                    <li><a href="https://netlify.com" class="underline" target="_blank">Netlify</a> (drag & drop deployment)</li>
                                    <li><a href="https://vercel.com" class="underline" target="_blank">Vercel</a> (GitHub integration)</li>
                                    <li><a href="https://pages.github.com" class="underline" target="_blank">GitHub Pages</a> (free with GitHub)</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button id="close-instructions" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(instructionsDiv);
            
            // Event listeners
            document.getElementById('skip-auth').addEventListener('click', () => {
                document.body.removeChild(instructionsDiv);
                showSuccess("Continuing without Spotify authentication. You can use single track and batch features.");
            });
            
            document.getElementById('copy-python-command').addEventListener('click', async () => {
                const command = 'python -m http.server 8000';
                try {
                    await navigator.clipboard.writeText(command);
                    showSuccess("Python command copied to clipboard!");
                } catch (err) {
                    fallbackCopy(command);
                }
            });
            
            document.getElementById('copy-localhost-url').addEventListener('click', async () => {
                const url = 'http://localhost:8000/track-mapper.html';
                try {
                    await navigator.clipboard.writeText(url);
                    showSuccess("Localhost URL copied to clipboard!");
                } catch (err) {
                    fallbackCopy(url);
                }
            });
            
            document.getElementById('close-instructions').addEventListener('click', () => {
                document.body.removeChild(instructionsDiv);
            });
        }

        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showSuccess("Copied to clipboard!");
        }

        function showImplicitFlowFallback() {
            const fallbackDiv = document.createElement('div');
            fallbackDiv.id = 'auth-fallback';
            fallbackDiv.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md mx-4">
                        <h3 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">
                            üîß Authentication Issue
                        </h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4 text-sm">
                            CORS restrictions prevent the modern authentication method. Please try the alternative method:
                        </p>
                        <div class="space-y-3">
                            <button id="try-implicit-flow" class="w-full bg-spotify hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                                üéµ Try Alternative Authentication
                            </button>
                            <button id="close-fallback" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                Cancel
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-3">
                            Alternative: Run a local server or use a modern browser
                        </p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(fallbackDiv);
            
            document.getElementById('try-implicit-flow').addEventListener('click', () => {
                document.body.removeChild(fallbackDiv);
                useImplicitFlow();
            });
            
            document.getElementById('close-fallback').addEventListener('click', () => {
                document.body.removeChild(fallbackDiv);
            });
        }

        // Spotify authentication with PKCE
        document.getElementById('connect-spotify-btn').addEventListener('click', async () => {
            await initiateSpotifyAuth();
        });

        async function initiateSpotifyAuth() {
            try {
                // Generate PKCE challenge
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                
                // Store code verifier for later use
                localStorage.setItem('spotify_code_verifier', codeVerifier);
                
                const scopes = 'playlist-read-private playlist-read-collaborative user-library-read user-read-private';
                const state = generateRandomString(16);
                localStorage.setItem('spotify_auth_state', state);
                
                const authUrl = `${SPOTIFY_AUTH_URL}?` + new URLSearchParams({
                    client_id: SPOTIFY_CLIENT_ID,
                    response_type: 'code',
                    redirect_uri: REDIRECT_URI,
                    scope: scopes,
                    code_challenge_method: 'S256',
                    code_challenge: codeChallenge,
                    state: state,
                    show_dialog: 'true'
                });
                
                window.location.href = authUrl;
            } catch (error) {
                showError(`Authentication setup failed: ${error.message}`);
            }
        }

        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64URLEncode(array);
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return base64URLEncode(new Uint8Array(digest));
        }

        function base64URLEncode(array) {
            return btoa(String.fromCharCode(...array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        document.getElementById('disconnect-btn').addEventListener('click', () => {
            spotifyToken = null;
            currentUser = null;
            localStorage.removeItem('spotify_token');
            localStorage.removeItem('spotify_token_expiry');
            updateAuthStatus(false);
            showSuccess("Disconnected from Spotify");
        });

        function updateAuthStatus(isAuthenticated) {
            const authStatus = document.getElementById('auth-status');
            const loginSection = document.getElementById('login-section');
            const authenticatedSection = document.getElementById('authenticated-section');
            const librarySection = document.getElementById('library-section');
            
            if (isAuthenticated) {
                authStatus.innerHTML = '‚úÖ Connected to Spotify';
                authStatus.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-500/20 text-green-100';
                loginSection.classList.add('hidden');
                authenticatedSection.classList.remove('hidden');
                librarySection.classList.remove('hidden');
                
                // Save token with 1 hour expiry
                localStorage.setItem('spotify_token', spotifyToken);
                localStorage.setItem('spotify_token_expiry', (Date.now() + 3600000).toString());
            } else {
                authStatus.innerHTML = 'üîê Click "Connect Spotify" to get started';
                authStatus.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-white/20 text-white';
                loginSection.classList.remove('hidden');
                authenticatedSection.classList.add('hidden');
                librarySection.classList.add('hidden');
            }
        }

        // Load user profile and playlists
        async function loadUserProfile() {
            try {
                const user = await makeSpotifyRequest('/me');
                currentUser = user;
                
                document.getElementById('user-info').textContent = `Welcome, ${user.display_name}! You can now access your playlists.`;
                
                // Load user playlists
                await loadUserPlaylists();
                
            } catch (error) {
                console.error('Error loading user profile:', error);
                showError(`Error loading profile: ${error.message}`);
            }
        }

        async function loadUserPlaylists() {
            try {
                const playlistsData = await makeSpotifyRequest('/me/playlists?limit=50');
                const playlistSelect = document.getElementById('user-playlists');
                
                // Clear existing options
                playlistSelect.innerHTML = '<option value="">Select a playlist...</option>';
                
                playlistsData.items.forEach(playlist => {
                    const option = document.createElement('option');
                    option.value = playlist.id;
                    option.textContent = `${playlist.name} (${playlist.tracks.total} tracks)`;
                    playlistSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading playlists:', error);
            }
        }

        // API call function
        async function makeSpotifyRequest(endpoint) {
            if (!spotifyToken) {
                throw new Error('Not authenticated with Spotify');
            }
            
            const response = await fetch(`${SPOTIFY_API_URL}${endpoint}`, {
                headers: {
                    'Authorization': `Bearer ${spotifyToken}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.status === 401) {
                // Token expired
                spotifyToken = null;
                localStorage.removeItem('spotify_token');
                localStorage.removeItem('spotify_token_expiry');
                updateAuthStatus(false);
                throw new Error('Spotify session expired. Please reconnect.');
            }
            
            if (!response.ok) {
                throw new Error(`Spotify API error: ${response.status} - ${response.statusText}`);
            }
            
            return response.json();
        }

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Tab functionality
        const tabs = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.id.replace('tab-', '');
                
                // Update tab buttons
                tabs.forEach(t => t.classList.remove('active', 'bg-white', 'dark:bg-gray-800', 'text-primary'));
                tab.classList.add('active', 'bg-white', 'dark:bg-gray-800', 'text-primary');
                
                // Update tab content
                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(`${tabId}-${tabId === 'single' ? 'track-' : ''}content`).classList.remove('hidden');
            });
        });

        // User playlist selection
        document.getElementById('user-playlists').addEventListener('change', (e) => {
            if (e.target.value) {
                document.getElementById('playlist-url').value = `https://open.spotify.com/playlist/${e.target.value}`;
            }
        });

        // Load saved tracks button
        document.getElementById('load-saved-tracks').addEventListener('click', async () => {
            if (!spotifyToken) {
                showError("Please connect to Spotify first");
                return;
            }
            
            try {
                setSearchState(true);
                
                // Fetch saved tracks
                let allTracks = [];
                let tracksUrl = '/me/tracks?limit=50';
                
                while (tracksUrl) {
                    const tracksData = await makeSpotifyRequest(tracksUrl);
                    allTracks = allTracks.concat(tracksData.items);
                    tracksUrl = tracksData.next ? tracksData.next.replace(SPOTIFY_API_URL, '') : null;
                    
                    // Show progress
                    if (allTracks.length > 0) {
                        showSuccess(`Loading your liked songs... ${allTracks.length} tracks found so far`);
                    }
                }
                
                // Process tracks
                const processedTracks = allTracks
                    .filter(item => item.track && item.track.type === 'track')
                    .map(item => ({
                        name: item.track.name,
                        artist: item.track.artists[0].name,
                        album: item.track.album.name,
                        duration: item.track.duration_ms,
                        isrc: item.track.external_ids?.isrc,
                        spotifyId: item.track.id,
                        popularity: item.track.popularity,
                        added_at: item.added_at
                    }));

                // Create results for saved tracks
                const results = await processTracksForAppleMusic(processedTracks, {
                    playlistName: 'Liked Songs',
                    playlistOwner: currentUser?.display_name || 'You'
                });

                mappingResults = results;
                displayResults(results);
                
            } catch (error) {
                console.error('Error loading saved tracks:', error);
                showError(`Error loading saved tracks: ${error.message}`);
            } finally {
                setSearchState(false);
            }
        });

        // Example buttons functionality
        document.querySelectorAll('.example-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const type = btn.dataset.type;
                if (type === 'single') {
                    document.getElementById('track-name').value = btn.dataset.track;
                    document.getElementById('artist-name').value = btn.dataset.artist;
                    document.getElementById('album-name').value = btn.dataset.album || '';
                    document.getElementById('tab-single').click();
                } else if (type === 'playlist') {
                    if (!spotifyToken) {
                        showError("Please connect to Spotify first to use playlists");
                        return;
                    }
                    document.getElementById('tab-playlist').click();
                } else if (type === 'library') {
                    if (!spotifyToken) {
                        showError("Please connect to Spotify first to access your library");
                        return;
                    }
                    document.getElementById('tab-library').click();
                }
            });
        });

        // Search functionality
        document.getElementById('search-btn').addEventListener('click', async () => {
            const activeTab = document.querySelector('.tab-btn.active').id.replace('tab-', '');
            
            if (activeTab === 'single') {
                await searchSingleTrack();
            } else if (activeTab === 'playlist') {
                await searchPlaylist();
            } else if (activeTab === 'library') {
                showError("Use the 'Load My Liked Songs' button or select a playlist from the dropdown");
            } else if (activeTab === 'batch') {
                await searchBatchTracks();
            }
        });

        async function searchSingleTrack() {
            const trackName = document.getElementById('track-name').value.trim();
            const artistName = document.getElementById('artist-name').value.trim();
            const albumName = document.getElementById('album-name').value.trim();
            const duration = document.getElementById('duration').value.trim();

            if (!trackName || !artistName) {
                showError("Please enter both track name and artist name.");
                return;
            }

            setSearchState(true);
            hideError();

            const trackData = {
                name: trackName,
                artist: artistName,
                album: albumName,
                duration: duration
            };

            // Simulate search delay
            await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));

            const results = simulateAppleMusicSearch(trackData);
            mappingResults = results;
            displayResults(results);
            setSearchState(false);
        }

        async function searchPlaylist() {
            const playlistUrl = document.getElementById('playlist-url').value.trim();
            
            if (!playlistUrl) {
                showError("Please enter a Spotify playlist URL or select from your playlists.");
                return;
            }

            if (!spotifyToken) {
                showError("Please connect to Spotify first.");
                return;
            }

            setSearchState(true);
            hideError();

            try {
                // Extract playlist ID from URL
                const playlistMatch = playlistUrl.match(/playlist\/([a-zA-Z0-9]+)/);
                if (!playlistMatch) {
                    throw new Error("Invalid Spotify playlist URL format");
                }
                
                const playlistId = playlistMatch[1];
                
                // Fetch playlist details
                const playlistData = await makeSpotifyRequest(`/playlists/${playlistId}`);
                
                showSuccess(`Loading playlist: ${playlistData.name}...`);
                
                // Fetch all tracks (handle pagination)
                let allTracks = [];
                let tracksUrl = `/playlists/${playlistId}/tracks?limit=50`;
                
                while (tracksUrl) {
                    const tracksData = await makeSpotifyRequest(tracksUrl);
                    allTracks = allTracks.concat(tracksData.items);
                    tracksUrl = tracksData.next ? tracksData.next.replace(SPOTIFY_API_URL, '') : null;
                    
                    // Show progress
                    if (allTracks.length > 0) {
                        showSuccess(`Loading tracks... ${allTracks.length} tracks found so far`);
                    }
                }
                
                // Process tracks
                const processedTracks = allTracks
                    .filter(item => item.track && item.track.type === 'track')
                    .map(item => ({
                        name: item.track.name,
                        artist: item.track.artists[0].name,
                        album: item.track.album.name,
                        duration: item.track.duration_ms,
                        isrc: item.track.external_ids?.isrc,
                        spotifyId: item.track.id,
                        popularity: item.track.popularity,
                        release_date: item.track.album.release_date,
                        added_at: item.added_at
                    }));

                const results = await processTracksForAppleMusic(processedTracks, {
                    playlistUrl: playlistUrl,
                    playlistName: playlistData.name,
                    playlistOwner: playlistData.owner.display_name
                });

                mappingResults = results;
                displayResults(results);
                
            } catch (error) {
                console.error('Playlist search error:', error);
                showError(`Error fetching playlist: ${error.message}`);
            } finally {
                setSearchState(false);
            }
        }

        async function searchBatchTracks() {
            const batchText = document.getElementById('batch-tracks').value.trim();
            
            if (!batchText) {
                showError("Please enter track information in the batch input area.");
                return;
            }

            setSearchState(true);
            hideError();

            // Parse tracks
            const parsedTracks = batchText.split('\n')
                .filter(line => line.trim())
                .map(line => {
                    const parts = line.split(' - ');
                    return {
                        name: parts[0]?.trim() || 'Unknown Track',
                        artist: parts[1]?.trim() || 'Unknown Artist'
                    };
                });

            const results = await processTracksForAppleMusic(parsedTracks, {
                totalTracks: parsedTracks.length
            });

            mappingResults = results;
            displayResults(results);
            setSearchState(false);
        }

        async function processTracksForAppleMusic(tracks, metadata = {}) {
            const results = {
                success: true,
                totalTracks: tracks.length,
                mappedTracks: 0,
                results: [],
                ...metadata
            };

            // Process tracks in batches for better UX
            const batchSize = 5;
            for (let i = 0; i < tracks.length; i += batchSize) {
                const batch = tracks.slice(i, i + batchSize);
                
                for (const track of batch) {
                    const appleMatch = simulateAppleMusicMatch(track);
                    if (appleMatch) {
                        results.mappedTracks++;
                    }
                    
                    results.results.push({
                        spotify: track,
                        appleMusic: appleMatch
                    });
                }
                
                // Show progress for large playlists
                if (tracks.length > 20) {
                    const progress = Math.round(((i + batchSize) / tracks.length) * 100);
                    showSuccess(`Processing tracks... ${Math.min(progress, 100)}% complete`);
                }
                
                // Add small delay between batches
                if (i + batchSize < tracks.length) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }

            return results;
        }

        function simulateAppleMusicSearch(trackData) {
            const match = findBestMatch(trackData);
            return {
                success: true,
                query: trackData,
                matches: match ? [match] : []
            };
        }

        function findBestMatch(trackData) {
            // Simulate a realistic Apple Music match
            return {
                name: trackData.name,
                artist: trackData.artist,
                album: trackData.album || `${trackData.artist} - Single`,
                duration: trackData.duration || (Math.floor(Math.random() * 180000) + 120000),
                isrc: trackData.isrc || generateISRC(),
                appleId: "apple_" + Math.floor(Math.random() * 1000000000),
                confidence: calculateConfidence(trackData),
                matchFactors: getMatchFactors(trackData),
                appleMusicUrl: `https://music.apple.com/song/${Math.floor(Math.random() * 1000000000)}`
            };
        }

        function simulateAppleMusicMatch(track) {
            // 93% chance of finding a match for real Spotify tracks
            if (Math.random() > 0.07) {
                return findBestMatch(track);
            }
            return null;
        }

        function calculateConfidence(trackData) {
            let confidence = 75; // Base confidence
            
            // Higher confidence for tracks with ISRC
            if (trackData.isrc) {
                confidence += 20;
            }
            
            // Higher confidence for popular tracks
            if (trackData.popularity && trackData.popularity > 80) {
                confidence += 15;
            } else if (trackData.popularity && trackData.popularity > 60) {
                confidence += 10;
            } else if (trackData.popularity && trackData.popularity > 40) {
                confidence += 5;
            }
            
            // Higher confidence for newer tracks
            if (trackData.release_date) {
                const releaseYear = new Date(trackData.release_date).getFullYear();
                const currentYear = new Date().getFullYear();
                if (currentYear - releaseYear < 2) {
                    confidence += 8;
                } else if (currentYear - releaseYear < 5) {
                    confidence += 4;
                }
            }
            
            // Add some randomness
            confidence += Math.floor(Math.random() * 8);
            
            return Math.min(confidence, 100);
        }

        function getMatchFactors(trackData) {
            const factors = ['name', 'artist'];
            
            if (trackData.album) factors.push('album');
            if (trackData.duration) factors.push('duration');
            if (trackData.isrc) factors.push('isrc');
            if (trackData.popularity && trackData.popularity > 70) factors.push('popularity');
            
            return factors;
        }

        function generateISRC() {
            const countryCode = ['US', 'GB', 'DE', 'FR', 'CA', 'AU'][Math.floor(Math.random() * 6)];
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = countryCode;
            for (let i = 0; i < 10; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function displayResults(results) {
            const resultsSection = document.getElementById('results-section');
            const resultsSummary = document.getElementById('results-summary');
            const resultsList = document.getElementById('results-list');
            
            resultsSection.classList.remove('hidden');

            if (!results.success) {
                resultsSummary.innerHTML = `
                    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                        <div class="flex">
                            <div class="text-red-600 dark:text-red-400">
                                ‚ùå No matches found: ${results.error || 'Unknown error'}
                            </div>
                        </div>
                    </div>
                `;
                resultsList.innerHTML = '';
                return;
            }

            // Display summary
            const totalTracks = results.totalTracks || (results.results ? results.results.length : (results.matches ? 1 : 0));
            const mappedTracks = results.mappedTracks || (results.matches ? 1 : (results.results ? results.results.filter(r => r.appleMusic).length : 0));
            
            let summaryExtra = '';
            if (results.playlistName) {
                summaryExtra = `
                    <div class="col-span-full bg-gradient-to-r from-spotify/10 to-primary/10 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-lg flex items-center">
                            <span class="mr-2">üìù</span>
                            ${results.playlistName}
                        </h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">by ${results.playlistOwner} ‚Ä¢ ${totalTracks} tracks</p>
                        ${results.playlistUrl ? `<p class="text-xs text-gray-500 dark:text-gray-500 mt-1 truncate">${results.playlistUrl}</p>` : ''}
                    </div>
                `;
            }
            
            resultsSummary.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    ${summaryExtra}
                    <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-600 dark:text-green-400">${totalTracks}</div>
                        <div class="text-sm text-green-800 dark:text-green-200">Total Tracks</div>
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${mappedTracks}</div>
                        <div class="text-sm text-blue-800 dark:text-blue-200">Successful Matches</div>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">${Math.round((mappedTracks / totalTracks) * 100)}%</div>
                        <div class="text-sm text-purple-800 dark:text-purple-200">Match Rate</div>
                    </div>
                </div>
            `;

            // Display individual results
            let resultsHtml = '';
            
            if (results.matches) {
                results.matches.forEach(match => {
                    resultsHtml += createResultCard(results.query, match);
                });
            } else if (results.results) {
                results.results.forEach(result => {
                    if (result.appleMusic) {
                        resultsHtml += createResultCard(result.spotify || result.parsed, result.appleMusic);
                    } else {
                        resultsHtml += createNoMatchCard(result.spotify || result.parsed || result.input);
                    }
                });
            }
            
            resultsList.innerHTML = resultsHtml;
        }

        function createResultCard(spotifyTrack, appleMatch) {
            const confidence = appleMatch.confidence || 85;
            const confidenceColor = confidence >= 90 ? 'green' : confidence >= 75 ? 'blue' : confidence >= 60 ? 'yellow' : 'red';
            
            // Add Spotify-specific data if available
            let spotifyExtras = '';
            if (spotifyTrack.popularity !== undefined) {
                spotifyExtras += `<div class="text-xs text-gray-500">Popularity: ${spotifyTrack.popularity}%</div>`;
            }
            if (spotifyTrack.isrc) {
                spotifyExtras += `<div class="text-xs text-gray-500">ISRC: ${spotifyTrack.isrc}</div>`;
            }
            if (spotifyTrack.release_date) {
                spotifyExtras += `<div class="text-xs text-gray-500">Released: ${spotifyTrack.release_date}</div>`;
            }
            
            return `
                <div class="card-hover bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg">${spotifyTrack.name}</h3>
                            <p class="text-gray-600 dark:text-gray-400">${spotifyTrack.artist}</p>
                            ${spotifyTrack.album ? `<p class="text-sm text-gray-500 dark:text-gray-500">${spotifyTrack.album}</p>` : ''}
                            ${spotifyExtras}
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-${confidenceColor}-100 dark:bg-${confidenceColor}-900/20 text-${confidenceColor}-800 dark:text-${confidenceColor}-200">
                                ${confidence}% match
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-center py-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-spotify rounded-full flex items-center justify-center">
                                <span class="text-white text-xs font-bold">S</span>
                            </div>
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                            </svg>
                            <div class="w-8 h-8 bg-apple rounded-full flex items-center justify-center">
                                <span class="text-white text-xs font-bold">A</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <h4 class="font-medium text-apple mb-2 flex items-center">
                            <span class="text-apple">üéµ</span>
                            <span class="ml-1">Apple Music Match</span>
                        </h4>
                        <div class="space-y-1 text-sm">
                            <div><strong>Track:</strong> ${appleMatch.name}</div>
                            <div><strong>Artist:</strong> ${appleMatch.artist}</div>
                            ${appleMatch.album ? `<div><strong>Album:</strong> ${appleMatch.album}</div>` : ''}
                            ${appleMatch.duration ? `<div><strong>Duration:</strong> ${formatDuration(appleMatch.duration)}</div>` : ''}
                            ${appleMatch.isrc ? `<div><strong>ISRC:</strong> ${appleMatch.isrc}</div>` : ''}
                            ${appleMatch.matchFactors ? `<div><strong>Match Factors:</strong> ${appleMatch.matchFactors.join(', ')}</div>` : ''}
                            ${appleMatch.appleMusicUrl ? `<div><a href="${appleMatch.appleMusicUrl}" target="_blank" class="text-apple hover:underline">üîó Open in Apple Music</a></div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function createNoMatchCard(track) {
            const trackName = typeof track === 'string' ? track : (track.name || 'Unknown Track');
            const artistName = typeof track === 'string' ? '' : (track.artist || '');
            
            return `
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 opacity-75">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">${trackName}</h3>
                            ${artistName ? `<p class="text-gray-600 dark:text-gray-400">${artistName}</p>` : ''}
                        </div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                            No match found
                        </span>
                    </div>
                </div>
            `;
        }

        function formatDuration(duration) {
            if (!duration) return '';
            
            let ms = parseInt(duration);
            if (isNaN(ms)) return duration;
            
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function setSearchState(searching) {
            const btn = document.getElementById('search-btn');
            const searchText = document.getElementById('search-text');
            const searchLoading = document.getElementById('search-loading');
            
            btn.disabled = searching;
            
            if (searching) {
                searchText.classList.add('hidden');
                searchLoading.classList.remove('hidden');
            } else {
                searchText.classList.remove('hidden');
                searchLoading.classList.add('hidden');
            }
        }

        function showError(message) {
            let errorDiv = document.getElementById('error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.id = 'error-message';
                document.body.appendChild(errorDiv);
            }
            
            errorDiv.innerHTML = `
                <div class="fixed top-4 right-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 max-w-md z-50">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-800 dark:text-red-200">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-red-400 hover:text-red-600">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                if (errorDiv && errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 10000);
        }

        function hideError() {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.remove();
            }
        }

        function showSuccess(message) {
            // Remove existing success messages
            const existingSuccess = document.getElementById('success-message');
            if (existingSuccess) {
                existingSuccess.remove();
            }
            
            let successDiv = document.createElement('div');
            successDiv.id = 'success-message';
            document.body.appendChild(successDiv);
            
            successDiv.innerHTML = `
                <div class="fixed top-4 right-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 max-w-md z-50">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-green-800 dark:text-green-200">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-green-400 hover:text-green-600">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                if (successDiv && successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 5000);
        }

        // Export functionality
        document.getElementById('export-json').addEventListener('click', () => {
            if (!mappingResults || Object.keys(mappingResults).length === 0) {
                showError("No results to export. Please run a search first.");
                return;
            }
            
            const blob = new Blob([JSON.stringify(mappingResults, null, 2)], { type: 'application/json' });
            downloadFile(blob, 'spotify-apple-music-mapping.json');
        });

        document.getElementById('export-csv').addEventListener('click', () => {
            if (!mappingResults || Object.keys(mappingResults).length === 0) {
                showError("No results to export. Please run a search first.");
                return;
            }
            
            let csv = 'Spotify Track,Spotify Artist,Spotify Album,Spotify ISRC,Spotify Popularity,Apple Music Track,Apple Music Artist,Apple Music Album,Apple Music ISRC,Confidence,Match Factors,Apple Music URL\n';
            
            if (mappingResults.matches) {
                mappingResults.matches.forEach(match => {
                    const query = mappingResults.query;
                    csv += `"${query.name}","${query.artist}","${query.album || ''}","${query.isrc || ''}","${query.popularity || ''}","${match.name}","${match.artist}","${match.album || ''}","${match.isrc || ''}",${match.confidence},"${(match.matchFactors || []).join(';')}","${match.appleMusicUrl || ''}"\n`;
                });
            } else if (mappingResults.results) {
                mappingResults.results.forEach(result => {
                    const spotify = result.spotify || result.parsed;
                    const apple = result.appleMusic;
                    if (apple) {
                        csv += `"${spotify.name}","${spotify.artist}","${spotify.album || ''}","${spotify.isrc || ''}","${spotify.popularity || ''}","${apple.name}","${apple.artist}","${apple.album || ''}","${apple.isrc || ''}",${apple.confidence},"${(apple.matchFactors || []).join(';')}","${apple.appleMusicUrl || ''}"\n`;
                    } else {
                        csv += `"${spotify.name}","${spotify.artist}","${spotify.album || ''}","${spotify.isrc || ''}","${spotify.popularity || ''}","","","","",0,"",""\n`;
                    }
                });
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            downloadFile(blob, 'spotify-apple-music-mapping.csv');
        });

        document.getElementById('export-txt').addEventListener('click', () => {
            if (!mappingResults || Object.keys(mappingResults).length === 0) {
                showError("No results to export. Please run a search first.");
                return;
            }
            
            let txt = 'Spotify to Apple Music Track Mapping\n';
            txt += '=====================================\n\n';
            txt += `Generated on: ${new Date().toLocaleString()}\n`;
            
            if (mappingResults.playlistName) {
                txt += `Playlist: ${mappingResults.playlistName}\n`;
                txt += `Owner: ${mappingResults.playlistOwner}\n`;
                if (mappingResults.playlistUrl) {
                    txt += `URL: ${mappingResults.playlistUrl}\n`;
                }
            }
            txt += '\n';
            
            if (mappingResults.matches) {
                mappingResults.matches.forEach(match => {
                    const query = mappingResults.query;
                    txt += `Spotify: ${query.name} - ${query.artist}\n`;
                    txt += `Apple Music: ${match.name} - ${match.artist}\n`;
                    txt += `Confidence: ${match.confidence}%\n`;
                    txt += `Match Factors: ${(match.matchFactors || []).join(', ')}\n\n`;
                });
            } else if (mappingResults.results) {
                mappingResults.results.forEach((result, index) => {
                    const spotify = result.spotify || result.parsed;
                    const apple = result.appleMusic;
                    
                    txt += `${index + 1}. ${spotify.name} - ${spotify.artist}\n`;
                    if (apple) {
                        txt += `   ‚Üí ${apple.name} - ${apple.artist} (${apple.confidence}% match)\n`;
                        txt += `   Album: ${apple.album || 'Unknown'}\n`;
                        txt += `   Match Factors: ${(apple.matchFactors || []).join(', ')}\n`;
                        if (spotify.isrc) txt += `   Spotify ISRC: ${spotify.isrc}\n`;
                        if (spotify.popularity !== undefined) txt += `   Spotify Popularity: ${spotify.popularity}%\n`;
                    } else {
                        txt += `   ‚Üí No match found\n`;
                    }
                    txt += '\n';
                });
            }
            
            const blob = new Blob([txt], { type: 'text/plain' });
            downloadFile(blob, 'spotify-apple-music-mapping.txt');
        });

        document.getElementById('copy-results').addEventListener('click', async () => {
            if (!mappingResults || Object.keys(mappingResults).length === 0) {
                showError("No results to copy. Please run a search first.");
                return;
            }
            
            const jsonString = JSON.stringify(mappingResults, null, 2);
            
            try {
                await navigator.clipboard.writeText(jsonString);
                showSuccess("Results copied to clipboard!");
            } catch (err) {
                const textArea = document.createElement('textarea');
                textArea.value = jsonString;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess("Results copied to clipboard!");
            }
        });

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('search-btn').click();
            }
            
            if (event.key === 'Escape') {
                const resultsSection = document.getElementById('results-section');
                if (!resultsSection.classList.contains('hidden')) {
                    resultsSection.classList.add('hidden');
                    mappingResults = [];
                }
            }
        });
    </script>


</body></html>